<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>The Chore Game - Shop</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/shop.css">
</head>

<body>
    <header class="site-header">

        <div class="container">
            <a href="index.html">
                <img class="logo" src="images/Logo_THE_GREAT_CHORE_OFF_Icon.png" alt="Logo">
            </a>
            <div class="container-logo">
                <a href="index.html">
                    <img class src="images/Chore _Wars_logo_title_new.png" href="index.html" alt="The Chore Game">
                </a>
            </div>
            <nav class="main-nav">
                <a class="header-btn" href="index.html">Home</a>
                <a class="header-btn" href="shop.html">Shop</a>
            </nav>
        </div>
    </header>

    <main class="site-main container">
        <!-- points display with shop management in center -->
        <div class="points-display grid-3">
            <div class="points-box" id="left-points-box">
                <h3 id="left-header">Left Column</h3>
                <div class="points-value"><strong id="shop-left-points">0</strong> pts</div>
            </div>

            <!-- Shop management section (moved to center) -->
            <section class="shop-management">
                <div class="shop-header">
                    <h2>Shop Management</h2>
                    <button type="button" id="toggle-add-form" class="btn btn-add" aria-expanded="false"
                        aria-controls="add-item-form">
                        <span class="btn-text">Add Item</span>
                        <span class="btn-icon">+</span>
                    </button>
                </div>

                <!-- collapsible add-item form -->
                <form id="add-item-form" class="shop-form hidden" aria-label="Add shop item" novalidate>
                    <h3 class="shop-form-title">Add New Item</h3>
                    <div class="form-row">
                        <input id="item-name" name="name" type="text" required aria-required="true" aria-label="Name"
                            placeholder="Name*" />
                    </div>

                    <div class="form-row">
                        <textarea id="item-desc" name="description" rows="2" aria-label="Description (optional)"
                            placeholder="Description (optional)"></textarea>
                    </div>

                    <div class="form-row">
                        <input id="item-price" name="price" type="text" inputmode="numeric" pattern="[0-9,]*" required
                            aria-required="true" aria-label="Price (points)" placeholder="Price (points)*" />
                    </div>

                    <div class="form-row">
                        <label for="item-one-time">One-time purchase</label>
                        <input id="item-one-time" name="oneTime" type="checkbox"
                            aria-label="Mark as one-time purchase" />
                    </div>

                    <div class="form-row">
                        <button type="submit">Add Item</button>
                        <span id="form-msg" class="form-msg" role="status" aria-live="polite"></span>
                    </div>
                </form>
            </section>

            <div class="points-box" id="right-points-box">
                <h3 id="right-header">Right Column</h3>
                <div class="points-value"><strong id="shop-right-points">0</strong> pts</div>
            </div>

            <!-- Extra player points boxes (row 2). Shown only if extras exist in index.html -->
            <div class="points-box" id="extra1-points-box">
                <h3 id="extra1-header">Player 3</h3>
                <div class="points-value"><strong id="shop-extra1-points">0</strong> pts</div>
            </div>
            <div class="points-box" id="extra2-points-box">
                <h3 id="extra2-header">Player 4</h3>
                <div class="points-value"><strong id="shop-extra2-points">0</strong> pts</div>
            </div>
            <div class="points-box" id="extra3-points-box">
                <h3 id="extra3-header">Player 5</h3>
                <div class="points-value"><strong id="shop-extra3-points">0</strong> pts</div>
            </div>
            <div class="points-box" id="extra4-points-box">
                <h3 id="extra4-header">Player 6</h3>
                <div class="points-value"><strong id="shop-extra4-points">0</strong> pts</div>
            </div>
            <div class="points-box" id="extra5-points-box">
                <h3 id="extra5-header">Player 7</h3>
                <div class="points-value"><strong id="shop-extra5-points">0</strong> pts</div>
            </div>
            <div class="points-box" id="extra6-points-box">
                <h3 id="extra6-header">Player 8</h3>
                <div class="points-value"><strong id="shop-extra6-points">0</strong> pts</div>
            </div>
            <div class="points-box" id="extra7-points-box">
                <h3 id="extra7-header">Player 9</h3>
                <div class="points-value"><strong id="shop-extra7-points">0</strong> pts</div>
            </div>
            <div class="points-box" id="extra8-points-box">
                <h3 id="extra8-header">Player 10</h3>
                <div class="points-value"><strong id="shop-extra8-points">0</strong> pts</div>
            </div>
        </div>

        <!-- Available items section -->
        <section class="shop-items">
            <h2>Available Items</h2>
            <div id="products" class="products-grid" aria-live="polite">
                <!-- items rendered here -->
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>© <span id="year2"></span> The Great Chore-Off: Made By: Sean Heiner, Parker Dragovich, Cole Popejoy, John Wendt, & Kendall Olson!
            </p>
            </p>
        </div>
    </footer>

    <script>
        // minimal shop logic: store items in localStorage, render them, allow adding + purchase/delete
        (function () {
            const STORAGE_KEY = 'tcg_shop_items_v1';
            const defaultItems = [
                { id: Date.now() + 1, name: 'Example', description: 'Example item', price: 50, oneTime: false },
                { id: Date.now() + 2, name: 'Product 2', description: '', price: 30, oneTime: true },
                { id: Date.now() + 3, name: 'Product 3', description: '', price: 20, oneTime: false }
            ];

            const form = document.getElementById('add-item-form');
            const nameInput = document.getElementById('item-name');
            const descInput = document.getElementById('item-desc');
            const priceInput = document.getElementById('item-price');
            const oneTimeInput = document.getElementById('item-one-time');
            const productsEl = document.getElementById('products');
            const msgEl = document.getElementById('form-msg');

            // helper: round to nearest 5 (clamped to >= 0)
            function roundToNearest5(n) {
                if (!Number.isFinite(n)) return 0;
                const r = Math.round(n / 5) * 5;
                return Math.max(0, r);
            }

            // Price field behavior: allow typing commas/letters, but sanitize on Enter or submit
            if (priceInput) {
                // On Enter key, strip all non-digits (keep integers only)
                priceInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const cleaned = (priceInput.value || '').replace(/[^0-9]/g, '');
                        priceInput.value = cleaned;
                    }
                });
            }

            function loadItems() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    return raw ? JSON.parse(raw) : defaultItems.slice();
                } catch (e) {
                    return defaultItems.slice();
                }
            }

            function saveItems(items) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
            }

            function createCard(item) {
                const art = document.createElement('article');
                art.className = 'card product';
                art.dataset.id = String(item.id);

                const titleWrap = document.createElement('div');
                titleWrap.className = 'product-title-wrap';

                const title = document.createElement('h3');
                title.className = 'product-title';
                title.textContent = item.name;
                titleWrap.appendChild(title);

                if (item.oneTime) {
                    const badge = document.createElement('span');
                    badge.className = 'badge one-time';
                    badge.textContent = 'One‑time';
                    titleWrap.appendChild(badge);
                }

                art.appendChild(titleWrap);

                if (item.description) {
                    const p = document.createElement('p');
                    p.className = 'product-desc';
                    p.textContent = item.description;
                    art.appendChild(p);
                }

                const price = document.createElement('p');
                price.className = 'product-price';
                price.textContent = item.price + ' pts';
                art.appendChild(price);

                // actions: purchase + delete
                const actions = document.createElement('div');
                actions.className = 'product-actions';

                const buyBtn = document.createElement('button');
                buyBtn.type = 'button';
                buyBtn.className = 'btn btn-purchase';
                buyBtn.dataset.action = 'purchase';
                buyBtn.textContent = 'Purchase';
                actions.appendChild(buyBtn);

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'btn btn-delete';
                delBtn.dataset.action = 'delete';
                delBtn.textContent = 'Delete';
                actions.appendChild(delBtn);

                art.appendChild(actions);

                return art;
            }

            function render() {
                const items = loadItems();
                productsEl.innerHTML = '';
                items.forEach(it => productsEl.appendChild(createCard(it)));
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                msgEl.textContent = '';

                const name = nameInput.value.trim();
                const desc = descInput.value.trim();
                // Strip commas and any letters; keep only digits before parsing
                const cleanedPrice = (priceInput.value || '').replace(/[^0-9]/g, '');
                priceInput.value = cleanedPrice; // reflect sanitized value in the UI
                const price = Number(cleanedPrice);
                const oneTime = !!oneTimeInput.checked;

                if (!name) {
                    msgEl.textContent = 'Name is required.';
                    nameInput.focus();
                    return;
                }
                // Require at least one digit; treat empty/invalid as error
                if (cleanedPrice === '' || Number.isNaN(price) || price < 0) {
                    msgEl.textContent = 'Enter a valid price (0 or more).';
                    priceInput.focus();
                    return;
                }

                const items = loadItems();
                // round price to nearest multiple of 5 before saving
                const roundedPrice = roundToNearest5(price);
                const newItem = { id: Date.now(), name, description: desc, price: roundedPrice, oneTime };
                items.push(newItem);
                saveItems(items);
                render();

                form.reset();
                msgEl.textContent = 'Item added.';
                setTimeout(() => msgEl.textContent = '', 2000);
            });

            // delegated click handler for purchase / delete
            productsEl.addEventListener('click', function (e) {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                const action = btn.dataset.action;
                const card = btn.closest('.product');
                if (!card) return;
                const id = Number(card.dataset.id);
                if (action === 'purchase') {
                    purchaseItem(id);
                } else if (action === 'delete') {
                    deleteItem(id);
                }
            });

            // Combined purchase modal: shows all players and cancel button
            function askPayerChoice(players, price, itemName) {
                // players is an array of {loc: 'left'|'right'|'extra1'|'extra2', name: 'Name'}
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'tcg-modal-overlay';
                    const modal = document.createElement('div');
                    modal.className = 'tcg-modal';

                    // Make modal larger to accommodate all players
                    modal.style.maxWidth = '600px';
                    modal.style.width = '90vw';
                    modal.style.padding = '24px';

                    const title = document.createElement('h3');
                    title.textContent = `Purchase "${itemName}" for ${price} pts?`;
                    title.style.margin = '0 0 20px 0';
                    title.style.textAlign = 'center';
                    title.style.fontSize = '1.2rem';
                    modal.appendChild(title);

                    const subtitle = document.createElement('p');
                    subtitle.textContent = 'Select which player will pay:';
                    subtitle.style.margin = '0 0 16px 0';
                    subtitle.style.textAlign = 'center';
                    subtitle.style.color = '#666';
                    subtitle.style.fontSize = '0.9rem';
                    modal.appendChild(subtitle);

                    // Player selection buttons in a grid
                    const playerGrid = document.createElement('div');
                    playerGrid.style.display = 'grid';
                    playerGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(140px, 1fr))';
                    playerGrid.style.gap = '12px';
                    playerGrid.style.marginBottom = '20px';

                    const buttons = [];
                    players.forEach(player => {
                        const btn = document.createElement('button');
                        btn.textContent = player.name.toUpperCase();
                        btn.dataset.loc = player.loc;
                        btn.style.padding = '12px 8px';
                        btn.style.borderRadius = '8px';
                        btn.style.border = 'none';
                        btn.style.cursor = 'pointer';
                        btn.style.color = 'white';
                        btn.style.fontWeight = 'bold';
                        btn.style.fontSize = '0.9rem';
                        btn.style.transition = 'transform 0.1s, box-shadow 0.1s';
                        btn.style.textAlign = 'center';
                        btn.style.wordWrap = 'break-word';

                        // Apply background color based on player location
                        if (player.loc === 'left') {
                            btn.style.backgroundColor = '#66CED6'; // Blue for left
                        } else if (player.loc === 'right') {
                            btn.style.backgroundColor = '#FF4242'; // Red for right
                        } else if (player.loc === 'extra1') {
                            btn.style.backgroundColor = 'orange'; // Orange for Player 3
                        } else if (player.loc === 'extra2') {
                            btn.style.backgroundColor = 'limegreen'; // Limegreen for Player 4
                        } else if (player.loc === 'extra3') {
                            btn.style.backgroundColor = 'purple'; // Purple for Player 5
                        } else if (player.loc === 'extra4') {
                            btn.style.backgroundColor = 'gold'; // Gold for Player 6 (better contrast than yellow)
                            btn.style.color = 'black'; // Better readability on gold
                        } else if (player.loc === 'extra5') {
                            btn.style.backgroundColor = 'hotpink'; // Hot pink for Player 7
                        } else if (player.loc === 'extra6') {
                            btn.style.backgroundColor = '#8B4513'; // Saddle brown for Player 8
                        } else if (player.loc === 'extra7') {
                            btn.style.backgroundColor = '#696969'; // Dim gray for Player 9
                        } else if (player.loc === 'extra8') {
                            btn.style.backgroundColor = 'teal'; // Teal for Player 10
                        }

                        // Add hover effects
                        btn.addEventListener('mouseenter', () => {
                            btn.style.transform = 'scale(1.05)';
                            btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                        });
                        btn.addEventListener('mouseleave', () => {
                            btn.style.transform = 'scale(1)';
                            btn.style.boxShadow = 'none';
                        });

                        playerGrid.appendChild(btn);
                        buttons.push(btn);
                    });
                    modal.appendChild(playerGrid);

                    // Centered cancel button below
                    const cancelWrapper = document.createElement('div');
                    cancelWrapper.style.textAlign = 'center';
                    cancelWrapper.style.marginTop = '16px';
                    cancelWrapper.style.borderTop = '1px solid #ddd';
                    cancelWrapper.style.paddingTop = '16px';

                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'btn-cancel';
                    cancelBtn.style.backgroundColor = '#E24A4A';
                    cancelBtn.style.color = 'white';
                    cancelBtn.style.border = 'none';
                    cancelBtn.style.borderRadius = '8px';
                    cancelBtn.style.padding = '10px 24px';
                    cancelBtn.style.cursor = 'pointer';
                    cancelBtn.style.fontSize = '0.9rem';
                    cancelBtn.style.fontWeight = 'bold';
                    cancelBtn.style.transition = 'background-color 0.2s, transform 0.1s';

                    // Add hover effect for cancel button
                    cancelBtn.addEventListener('mouseenter', () => {
                        cancelBtn.style.backgroundColor = '#C13838';
                        cancelBtn.style.transform = 'scale(1.05)';
                    });
                    cancelBtn.addEventListener('mouseleave', () => {
                        cancelBtn.style.backgroundColor = '#E24A4A';
                        cancelBtn.style.transform = 'scale(1)';
                    });

                    cancelWrapper.appendChild(cancelBtn);
                    modal.appendChild(cancelWrapper);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);

                    function cleanup(choice) {
                        buttons.forEach(btn => {
                            btn.removeEventListener('click', onClick);
                            btn.removeEventListener('mouseenter', () => { });
                            btn.removeEventListener('mouseleave', () => { });
                        });
                        cancelBtn.removeEventListener('click', onCancel);
                        try { document.body.removeChild(overlay); } catch (e) { }
                        resolve(choice);
                    }

                    function onClick(e) {
                        const loc = e.target.dataset.loc;
                        cleanup(loc);
                    }

                    function onCancel() {
                        cleanup(null);
                    }

                    buttons.forEach(btn => btn.addEventListener('click', onClick));
                    cancelBtn.addEventListener('click', onCancel);
                });
            }

            // info helper: single-OK modal matching shop style
            function showInfo(message, okLabel = 'OK') {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'tcg-modal-overlay';
                    overlay.innerHTML = `
                                            <div class="tcg-modal">
                                                <p>${message}</p>
                                                <div class="tcg-modal-actions">
                                                                <button class="btn-ok">${okLabel}</button>
                                                </div>
                                            </div>`;
                    document.body.appendChild(overlay);
                    const okBtn = overlay.querySelector('button.btn-ok');
                    function cleanup() {
                        okBtn.removeEventListener('click', onOk);
                        try { document.body.removeChild(overlay); } catch (e) { }
                        resolve(true);
                    }
                    function onOk() { cleanup(); }
                    okBtn.addEventListener('click', onOk);
                });
            }

            // confirm helper: show a purchase confirmation modal (Confirm / Cancel)
            function askConfirmPurchase(itemName, price) {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'tcg-modal-overlay';
                    overlay.innerHTML = `
                                            <div class="tcg-modal">
                                                <p>Confirm purchase of "${itemName}" for ${price} pts?</p>
                                                <div class="tcg-modal-actions">
                                                    <button class="btn-cancel">Cancel</button>
                                                    <button class="btn-confirm">Confirm</button>
                                                </div>
                                            </div>`;
                    document.body.appendChild(overlay);
                    const cancelBtn = overlay.querySelector('button.btn-cancel');
                    const confirmBtn = overlay.querySelector('button.btn-confirm');
                    function cleanup(choice) {
                        cancelBtn.removeEventListener('click', onCancel);
                        confirmBtn.removeEventListener('click', onConfirm);
                        try { document.body.removeChild(overlay); } catch (e) { }
                        resolve(choice);
                    }
                    function onCancel() { cleanup(false); }
                    function onConfirm() { cleanup(true); }
                    cancelBtn.addEventListener('click', onCancel);
                    confirmBtn.addEventListener('click', onConfirm);
                });
            }

            // purchase handler (uses combined askPayerChoice)
            async function purchaseItem(id) {
                const items = loadItems();
                const idx = items.findIndex(i => i.id === id);
                if (idx === -1) return;
                const item = items[idx];

                // Get all currently active players
                const players = getActivePlayers();
                if (players.length === 0) {
                    await showInfo('No active players to purchase items.', 'OK');
                    return;
                }

                // Ask user which player should pay (combined modal with cancel)
                let payerLoc;
                try {
                    payerLoc = await askPayerChoice(players, item.price, item.name);
                } catch (e) { payerLoc = null; }
                if (!payerLoc) return; // user cancelled

                const payer = players.find(p => p.loc === payerLoc);
                if (!payer) return;

                // load point banks
                const points = loadPoints();
                const current = Number(points[payerLoc] || 0);
                if (current < item.price) {
                    // Get player color based on location
                    let playerColor = '';
                    if (payerLoc === 'left') playerColor = '#66CED6';
                    else if (payerLoc === 'right') playerColor = '#FF4242';
                    else if (payerLoc === 'extra1') playerColor = 'orange';
                    else if (payerLoc === 'extra2') playerColor = 'limegreen';
                    else if (payerLoc === 'extra3') playerColor = 'purple';
                    else if (payerLoc === 'extra4') playerColor = 'yellow';
                    else if (payerLoc === 'extra5') playerColor = 'pink';
                    else if (payerLoc === 'extra6') playerColor = 'brown';
                    else if (payerLoc === 'extra7') playerColor = 'gray';
                    else if (payerLoc === 'extra8') playerColor = 'teal';

                    await showInfo(`<span style="color: ${playerColor}; font-weight: bold;">${payer.name.toUpperCase()}</span> does not have enough points (${current} pts) <br> <span style="color: ${playerColor}; font-weight: bold;">${payer.name.toUpperCase()}</span> needs (${item.price} pts) to purchase this item.`, 'OK');
                    return;
                }

                // deduct and save
                points[payerLoc] = current - item.price;
                try { localStorage.setItem('tcg_points_v1', JSON.stringify(points)); } catch (e) { }
                // update the on-page point displays immediately
                try { renderPoints(); } catch (e) { }

                if (item.oneTime) {
                    // remove one-time items on purchase
                    items.splice(idx, 1);
                    saveItems(items);
                    render();
                    msgEl.textContent = `Purchased — ${item.name} removed. Charged ${payer.name}.`;
                } else {
                    msgEl.textContent = `Purchased. Charged ${payer.name}.`;
                }
                setTimeout(() => msgEl.textContent = '', 2000);
            }

            function deleteItem(id) {
                const items = loadItems();
                const idx = items.findIndex(i => i.id === id);
                if (idx === -1) return;
                const item = items[idx];
                // delete immediately without confirmation
                items.splice(idx, 1);
                saveItems(items);
                render();
                msgEl.textContent = 'Item deleted.';
                setTimeout(() => msgEl.textContent = '', 2000);
            }

            // points display functions
            function loadPoints() {
                try {
                    const raw = localStorage.getItem('tcg_points_v1');
                    const parsed = raw ? JSON.parse(raw) : { left: 0, right: 0 };
                    // ensure extras exist for compatibility
                    if (typeof parsed.left !== 'number') parsed.left = 0;
                    if (typeof parsed.right !== 'number') parsed.right = 0;
                    if (typeof parsed.extra1 !== 'number') parsed.extra1 = 0;
                    if (typeof parsed.extra2 !== 'number') parsed.extra2 = 0;
                    if (typeof parsed.extra3 !== 'number') parsed.extra3 = 0;
                    if (typeof parsed.extra4 !== 'number') parsed.extra4 = 0;
                    if (typeof parsed.extra5 !== 'number') parsed.extra5 = 0;
                    if (typeof parsed.extra6 !== 'number') parsed.extra6 = 0;
                    if (typeof parsed.extra7 !== 'number') parsed.extra7 = 0;
                    if (typeof parsed.extra8 !== 'number') parsed.extra8 = 0;
                    return parsed;
                } catch (e) {
                    return { left: 0, right: 0, extra1: 0, extra2: 0, extra3: 0, extra4: 0, extra5: 0, extra6: 0, extra7: 0, extra8: 0 };
                }
            }

            function loadHeaders() {
                try {
                    const raw = localStorage.getItem('tcg_column_headers_v1');
                    const parsed = raw ? JSON.parse(raw) : {};
                    return {
                        left: parsed.left || 'Left Column',
                        right: parsed.right || 'Right Column',
                        extra1: parsed.extra1 || 'Player 3',
                        extra2: parsed.extra2 || 'Player 4',
                        extra3: parsed.extra3 || 'Player 5',
                        extra4: parsed.extra4 || 'Player 6',
                        extra5: parsed.extra5 || 'Player 7',
                        extra6: parsed.extra6 || 'Player 8',
                        extra7: parsed.extra7 || 'Player 9',
                        extra8: parsed.extra8 || 'Player 10'
                    };
                } catch (e) {
                    return {
                        left: 'Left Column',
                        right: 'Right Column',
                        extra1: 'Player 3',
                        extra2: 'Player 4',
                        extra3: 'Player 5',
                        extra4: 'Player 6',
                        extra5: 'Player 7',
                        extra6: 'Player 8',
                        extra7: 'Player 9',
                        extra8: 'Player 10'
                    };
                }
            }

            function loadExtraState() {
                try {
                    const raw = localStorage.getItem('tcg_extra_cols_v1');
                    const parsed = raw ? JSON.parse(raw) : { extra1: false, extra2: false, extra3: false, extra4: false, extra5: false, extra6: false, extra7: false, extra8: false };
                    return {
                        extra1: !!parsed.extra1,
                        extra2: !!parsed.extra2,
                        extra3: !!parsed.extra3,
                        extra4: !!parsed.extra4,
                        extra5: !!parsed.extra5,
                        extra6: !!parsed.extra6,
                        extra7: !!parsed.extra7,
                        extra8: !!parsed.extra8
                    };
                } catch (e) {
                    return { extra1: false, extra2: false, extra3: false, extra4: false, extra5: false, extra6: false, extra7: false, extra8: false };
                }
            }

            // Base player state management
            function loadBasePlayerState() {
                try {
                    const raw = localStorage.getItem('base-player-state');
                    const p = raw ? JSON.parse(raw) : { left: true, right: true };
                    return { left: p.left !== false, right: p.right !== false };
                }
                catch (e) { return { left: true, right: true }; }
            }

            // Function to get all active players for shop
            function getActivePlayers() {
                const headers = loadHeaders();
                const st = loadExtraState();
                const baseState = loadBasePlayerState();
                const players = [];

                // Add base players only if they're active
                if (baseState.left !== false) {
                    players.push({ loc: 'left', name: headers.left || 'Player 1', isExtra: false, isBase: true });
                }
                if (baseState.right !== false) {
                    players.push({ loc: 'right', name: headers.right || 'Player 2', isExtra: false, isBase: true });
                }

                for (let i = 1; i <= 8; i++) {
                    const extraKey = `extra${i}`;
                    if (st[extraKey]) {
                        players.push({
                            loc: extraKey,
                            name: headers[extraKey] || `Player ${i + 2}`,
                            isExtra: true,
                            isBase: false
                        });
                    }
                }

                return players;
            }

            // Function to get current active extra players in position order
            function getActiveExtraPlayers() {
                const st = loadExtraState();
                const activeExtras = [];

                for (let i = 1; i <= 8; i++) {
                    const extraKey = `extra${i}`;
                    if (st[extraKey]) {
                        activeExtras.push({
                            key: extraKey,
                            number: i,
                            isLeft: i % 2 === 1
                        });
                    }
                }

                return activeExtras;
            }

            // Function to calculate optimal grid positions without gaps
            function calculateOptimalPositions() {
                const activeExtras = getActiveExtraPlayers();
                const leftPlayers = activeExtras.filter(p => p.isLeft).sort((a, b) => a.number - b.number);
                const rightPlayers = activeExtras.filter(p => p.isLeft === false).sort((a, b) => a.number - b.number);

                const positions = {};

                // Assign left side positions (starting from row 2)
                leftPlayers.forEach((player, index) => {
                    positions[player.key] = {
                        column: 1,
                        row: index + 2 // Start from row 2 (row 1 has base players)
                    };
                });

                // Assign right side positions (starting from row 2)
                rightPlayers.forEach((player, index) => {
                    positions[player.key] = {
                        column: 3,
                        row: index + 2 // Start from row 2 (row 1 has base players)
                    };
                });

                return positions;
            }

            // Function to reposition all extra point boxes to eliminate gaps
            function repositionAllExtraBoxes() {
                const positions = calculateOptimalPositions();

                // Update all existing extra boxes with their new positions
                Object.keys(positions).forEach(extraKey => {
                    const box = document.getElementById(`${extraKey}-points-box`);
                    if (box) {
                        const pos = positions[extraKey];
                        box.style.gridColumn = pos.column.toString();
                        box.style.gridRow = pos.row.toString();
                    }
                });
            }

            // Position the center shop-management so its extended form passes between extra players
            function updateShopManagementPosition() {
                const shopSection = document.querySelector('.shop-management');
                if (!shopSection) return;
                const extras = loadExtraState();
                const hasAnyExtras = extras.extra1 || extras.extra2 || extras.extra3 || extras.extra4 || extras.extra5 || extras.extra6 || extras.extra7 || extras.extra8;
                if (hasAnyExtras) {
                    // Span center section across multiple rows so content flows between them
                    shopSection.style.gridColumn = '2';
                    shopSection.style.gridRow = '1 / 6'; // Span from row 1 to 6 to accommodate all extra players
                } else {
                    // Default placement
                    shopSection.style.gridColumn = '';
                    shopSection.style.gridRow = '';
                }
            }

            function renderPoints() {
                const points = loadPoints();
                const headers = loadHeaders();
                const extras = loadExtraState();
                const baseState = loadBasePlayerState();

                // Handle base player visibility and updates
                const leftBox = document.getElementById('left-points-box');
                const rightBox = document.getElementById('right-points-box');

                if (leftBox) {
                    if (baseState.left !== false) {
                        leftBox.style.display = '';
                        document.getElementById('shop-left-points').textContent = String(points.left || 0);
                        document.getElementById('left-header').textContent = headers.left;
                    } else {
                        leftBox.style.display = 'none';
                    }
                }

                if (rightBox) {
                    if (baseState.right !== false) {
                        rightBox.style.display = '';
                        document.getElementById('shop-right-points').textContent = String(points.right || 0);
                        document.getElementById('right-header').textContent = headers.right;
                    } else {
                        rightBox.style.display = 'none';
                    }
                }

                // Handle extra players with dynamic positioning
                for (let i = 1; i <= 8; i++) {
                    const extraKey = `extra${i}`;
                    const extraBox = document.getElementById(`${extraKey}-points-box`);
                    if (extraBox) {
                        if (extras[extraKey]) {
                            extraBox.style.display = '';
                            const h = document.getElementById(`${extraKey}-header`);
                            const v = document.getElementById(`shop-${extraKey}-points`);
                            if (h) h.textContent = headers[extraKey] || `Player ${i + 2}`;
                            if (v) v.textContent = String(points[extraKey] || 0);
                        } else {
                            extraBox.style.display = 'none';
                        }
                    }
                }

                // Reposition all extra boxes to eliminate gaps
                repositionAllExtraBoxes();

                // Make sure the center section spans appropriately when extras are present
                updateShopManagementPosition();
            }

            // set year and initial render
            document.getElementById('year2').textContent = new Date().getFullYear();
            render();
            renderPoints(); // render initial points

            // re-render points when storage changes (in case points are updated in another tab)
            window.addEventListener('storage', (e) => {
                if (e.key === 'tcg_points_v1' || e.key === 'tcg_column_headers_v1' || e.key === 'tcg_extra_cols_v1' || e.key === 'base-player-state') {
                    renderPoints();
                    updateShopManagementPosition();
                }
            });

            // Add Items form toggle functionality
            const toggleBtn = document.getElementById('toggle-add-form');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const form = document.getElementById('add-item-form');
                    const isHidden = form.classList.contains('hidden');

                    // toggle form visibility
                    form.classList.toggle('hidden');

                    // update button state
                    toggleBtn.setAttribute('aria-expanded', String(!isHidden));
                    // ensure center section spans correctly relative to extras
                    try { updateShopManagementPosition(); } catch (e) { }

                    // if showing form, focus first input
                    if (isHidden) {
                        nameInput.focus();
                    }
                });

                // close form on successful add
                const originalSubmitHandler = form.onsubmit;
                form.addEventListener('submit', (e) => {
                    if (e.defaultPrevented) return; // if validation failed
                    form.classList.add('hidden');
                    toggleBtn.setAttribute('aria-expanded', 'false');
                    try { updateShopManagementPosition(); } catch (e) { }
                });
            }
        })();
    </script>
</body>

</html>